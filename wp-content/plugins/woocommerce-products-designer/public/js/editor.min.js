var WPD_EDITOR=function(t,e){"use strict";var e={};return e.canvas={},e.serialized_parts={},e.final_canvas_parts={},e.selected_part=-1,e.canvasManipulationsPosition=[],e.box_center_x=!1,e.box_center_y=!1,e.scale_factor=!1,e.arr_filters=["grayscale","invert","remove-white","sepia","sepia2","brightness","noise","gradient-transparency","pixelate","blur","convolute"],t(document).ready(function(){function a(){var e=t("#wpc-editor-container").outerWidth(),a=0,n=0;return 1==wpd.responsive&&wpd.canvas_w>e?(a=e,n=a*wpd.canvas_h/wpd.canvas_w):(a=wpd.canvas_w,n=wpd.canvas_h),[a,n]}function n(){e.canvas.forEachObject(function(t){"image"===t.type&&t.filters.length&&t.applyFilters(function(){t.canvas.renderAll()})})}function c(){var t=["canvas_h","canvas_w","clip_h","clip_r","clip_rr","clip_w","clip_x","clip_y","output_loop_delay","output_w"],e=0;for(e=0;e<t.length;e++)wpd[t[e]]=parseFloat(wpd[t[e]])}function o(){c();var t=a();e.canvas=new fabric.Canvas("wpc-editor",{width:t[0],height:t[1]}),e.canvas.backgroundImageStretch=!1,r(),e.canvas.renderAll(),i(),"undefined"!=typeof wpd&&(accounting.settings={currency:{symbol:wpd.currency,format:wpd.price_format,decimal:wpd.decimal_sep,thousand:wpd.thousand_sep,precision:wpd.nb_decimals},number:{precision:wpd.nb_decimals,thousand:wpd.thousand_sep,decimal:wpd.decimal_sep}})}function r(){var t=a();e.canvas.clipTo=null;var n=t[0]/wpd.canvas_w;if(1!=n&&(e.scale_factor=n),wpd.clip_w&&wpd.clip_h&&wpd.clip_w>0&&wpd.clip_h>0&&"rect"==wpd.clip_type){var c=(t[0]-wpd.clip_w*n)/2;(wpd.clip_x||"0"==wpd.clip_x)&&(c=wpd.clip_x*n,e.box_center_x=parseFloat(c)+parseFloat(wpd.clip_w*n)/2);var o=(t[1]-wpd.clip_h*n)/2;(wpd.clip_y||"0"==wpd.clip_y)&&(o=wpd.clip_y*n,e.box_center_y=parseFloat(o)+parseFloat(wpd.clip_h*n)/2),e.canvas.clipTo=function(t){("rect"==wpd.clip_type||""==wpd.clip_type)&&(wpd.clip_rr>0?D(t,c,o,parseFloat(wpd.clip_w*n),parseFloat(wpd.clip_h*n),parseFloat(wpd.clip_rr*n),"",wpd.clip_border):(t.rect(c,o,wpd.clip_w*n,wpd.clip_h*n),wpd.clip_border&&(t.strokeStyle=wpd.clip_border,t.stroke())))}}else if(wpd.clip_r&&wpd.clip_r>0&&"arc"==wpd.clip_type){var c=wpd.canvas_w/2;wpd.clip_x&&(c=wpd.clip_x*n);var o=t[1]-wpd.clip_h*n/2;wpd.clip_y&&(o=wpd.clip_y),e.canvas.clipTo=function(t){t.arc(c,o,wpd.clip_r*n,0,2*Math.PI),wpd.clip_border&&(t.strokeStyle=wpd.clip_border,t.stroke())}}}function i(){e.canvas.on("object:selected",function(e){if(t("#cb-curved").removeAttr("checked"),e.target){var a=e.target.type,n=["rect","circle","triangle","polygon","path"];if("i-text"==a){P.openPanel("text-panel"),t("#font-family-selector").val(e.target.get("fontFamily")),t("#font-size-selector").val(e.target.get("fontSize")),t("#txt-color-selector").css("background-color",e.target.get("fill")),t("#txt-bg-color-selector").css("background-color",e.target.get("backgroundColor")),t("#new-text").val(e.target.get("text")),t(".txt-align[value='"+e.target.get("textAlign")+"']").attr("checked","checked"),t(".txt-decoration[value='"+e.target.get("textDecoration")+"']").attr("checked","checked");var c=e.target.get("fontWeight");"bold"==c?t("#bold-cb").attr("checked","checked"):t("#bold-cb").removeAttr("checked");var o=e.target.get("fontStyle");"italic"==o?t("#italic-cb").attr("checked","checked"):t("#italic-cb").removeAttr("checked"),0!=e.target.get("stroke")&&null!=e.target.getStroke()?(t("#txt-outline-color-selector").css("background-color",e.target.get("stroke")),t("#o-thickness-slider").val(e.target.get("strokeWidth"))):t("#o-thickness-slider").val(0);var r=e.target.opacity;t("#opacity-slider").val(r)}else if("group"==a){if(e.target.get("originalText")){t("#cb-curved").attr("checked","checked"),P.openPanel("text-panel"),t("#font-family-selector").val(e.target.item(0).get("fontFamily")).trigger("change"),t("#font-size-selector").val(e.target.item(0).get("fontSize")),t("#txt-color-selector").css("background-color",e.target.item(0).get("fill")),t("#txt-bg-color-selector").css("background-color",e.target.item(0).get("backgroundColor")),t("#new-text").val(e.target.get("originalText")),t("#curved-txt-radius-slider").val(e.target.get("radius")),t("#curved-txt-spacing-slider").val(e.target.get("spacing")),t(".txt-align[value='"+e.target.item(0).get("textAlign")+"']").attr("checked","checked"),t(".txt-decoration[value='"+e.target.item(0).get("textDecoration")+"']").attr("checked","checked");var c=e.target.item(0).get("fontWeight");"bold"==c?t("#bold-cb").attr("checked","checked"):t("#bold-cb").removeAttr("checked");var o=e.target.item(0).get("fontStyle");"italic"==o?t("#italic-cb").attr("checked","checked"):t("#italic-cb").removeAttr("checked"),0!=e.target.item(0).get("stroke")&&null!=e.target.item(0).getStroke()?(t("#txt-outline-color-selector").css("background-color",e.target.item(0).get("stroke")),t("#o-thickness-slider").val(e.target.item(0).get("strokeWidth"))):t("#o-thickness-slider").val(0);var r=e.target.item(0).opacity;t("#opacity-slider").val(r)}}else if(jQuery.inArray(a,n)>=0){var i=e.target.opacity;t("#shape-opacity-slider").val(i),t("#shape-bg-color-selector").css("background-color",e.target.get("fill")),t("#shape-outline-color-selector").css("background-color",e.target.get("stroke")),t("#shape-thickness-slider").val(e.target.get("strokeWidth")),P.openPanel("shapes-panel")}else if("image"==a){s(e);var l=e.target.filters;t("#img-effects input:checkbox").removeAttr("checked"),t.each(l,function(e,a){if(a){var n=a.type,c=a.matrix,o=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],r=[0,-1,0,-1,5,-1,0,-1,0],i=[1,1,1,1,.7,-1,-1,-1,-1];"Grayscale"==n?t(".acd-grayscale").attr("checked","checked"):"Invert"==n?t(".acd-invert").attr("checked","checked"):"Sepia"==n?t(".acd-sepia").attr("checked","checked"):"Sepia2"==n?t(".acd-sepia2").attr("checked","checked"):"Convolute"==n?0==t(c).not(o).length&&0==t(o).not(c).length?t(".acd-blur").attr("checked","checked"):0==t(c).not(r).length&&0==t(r).not(c).length?t(".acd-sharpen").attr("checked","checked"):0==t(c).not(i).length&&0==t(i).not(c).length&&t(".acd-emboss").attr("checked","checked"):console.log(n,c)}}),wp.hooks.doAction("WPD_EDITOR.image_selected",e.target)}else if(("path"==a||"path-group"==a)&&"none"!=wpd.svg_colorization){var d=s(e);if(t("#"+d+" .clipart-bg-color-container").html(""),e.target.isSameColor&&e.target.isSameColor()||!e.target.paths){var p="clipart-bg-1-color-selector",u='<span id="'+p+'" class="svg-color-selector" data-placement="top" data-tooltip-title="'+wpd.translated_strings.svg_background_tooltip+'" style="background-color:'+e.target.get("fill")+'"></span>';t("#"+d+" .clipart-bg-color-container").append(u),t("[data-tooltip-title]").otooltip(),w(p)}else if(e.target.paths)for(var v=[],g=0,f=0;f<e.target.paths.length;f++){var p="clipart-bg-"+g+"-color-selector",_=e.target.paths[f].fill,u='<span id="'+p+'" class="svg-color-selector" data-placement="top" data-tooltip-title="'+wpd.translated_strings.svg_background_tooltip+'" style="background-color:'+_+'" data-index="'+f+'"></span>';if("by-colors"==wpd.svg_colorization){var h=jQuery.inArray(_,v);if(-1==h)t("#"+d+" .clipart-bg-color-container").append(u),t("[data-tooltip-title]").otooltip(),w(p),v.push(_),g++;else{var m="#clipart-bg-"+h+"-color-selector",b=t(m).attr("data-index");t(m).attr("data-index",b+","+f)}}else t("#"+d+" .clipart-bg-color-container").append(u),t("[data-tooltip-title]").otooltip(),w(p),g++}}e.target.get("lockMovementX")?t("#lock-mvt-x").attr("checked","checked"):t("#lock-mvt-x").removeAttr("checked"),e.target.get("lockMovementY")?t("#lock-mvt-y").attr("checked","checked"):t("#lock-mvt-y").removeAttr("checked"),e.target.get("lockScalingX")?t("#lock-scl-x").attr("checked","checked"):t("#lock-scl-x").removeAttr("checked"),e.target.get("lockScalingY")?t("#lock-scl-y").attr("checked","checked"):t("#lock-scl-y").removeAttr("checked"),e.target.get("lockDeletion")?t("#lock-Deletion").attr("checked","checked"):t("#lock-Deletion").removeAttr("checked")}}),e.canvas.on("object:added",function(t){if(t.target){e.canvas.calcOffset(),e.canvas.renderAll(),t.target.setCoords();var a=t.target.type;"i-text"==a&&k(),e.canvas.calcOffset()}}),e.canvas.on("object:modified",function(t){e.canvas.calcOffset(),e.canvas.renderAll(),t.target.setCoords(),e.save_canvas()})}function l(t){t.toObject=function(t){return function(){return fabric.util.object.extend(t.call(this),{lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,lockScalingX:this.lockScalingX,lockScalingY:this.lockScalingY,lockDeletion:this.lockDeletion,price:this.price,originalText:this.originalText,boundingBox:this.boundingBox,radius:this.radius,spacing:this.spacing})}}(t.toObject)}function s(e){var a=e.target.toObject(),n=a.src,c=t("#wpd-all-cliparts img[src='"+n+"']").length,o=t("#facebook-panel img[src='"+n+"']").length,r=t("#instagram-panel img[src='"+n+"']").length;return c?P.openPanel("cliparts-panel"):o?P.openPanel("facebook-panel"):r?P.openPanel("instagram-panel"):P.openPanel("uploads-panel"),c?"cliparts-panel":o?"facebook-panel":r?"instagram-panel":"uploads-panel"}function d(t,a,n){"txt-color-selector"==t||"shape-bg-color-selector"==t||"clipart-bg-color-selector"==t?a.set("fill","#"+n):"txt-bg-color-selector"==t?a.set("backgroundColor","#"+n):"txt-outline-color-selector"==t||"shape-outline-color-selector"==t?a.set("stroke","#"+n):console.log("unknow color selector :#"+t),wp.hooks.doAction("WPD_EDITOR.element_color_changed",t,a,n),e.canvas.renderAll()}function p(){var a=t("#wpc-parts-bar > li").length,n={},c=wpd.query_vars.tpl;"undefined"==typeof c&&(c=""),t.each(t(".wpc-qty-container"),function(e,a){var c=t(this).find(".wpd-qty").val();n[t(this).data("id")]=c});var o={};t.each(t("#wpc-parts-bar > li"),function(r,i){var l=t(this).attr("data-id");if(e.serialized_parts[l]){var s={};s.json=e.serialized_parts[l][e.canvasManipulationsPosition[l]],o[l]=s}t(this).index()==a-1&&t.post(ajax_object.ajax_url,{action:"get_design_price",variations:n,serialized_parts:JSON.stringify(o),tpl:c},function(a){if(e.is_json(a)){var n=JSON.parse(a);t.each(t(".wpc-qty-container"),function(e,a){var c=t(this).data("id"),o=n.prices[c],r=t(this).find(".wpd-qty");t(this).find(".total_order").html(accounting.formatMoney(o)),r.attr("uprice",o),r.trigger("change")})}else t("#debug").html(a)})})}function u(a){var n=t("#wpc-parts-bar > li").first().data("id");if("object"==typeof a){var c=!1;t.each(a,function(a,o){t.each(o,function(t,o){if("json"==t){e.serialized_parts[a]=[],e.canvasManipulationsPosition[a]=0;var r=o;e.serialized_parts[a].push(r),a==n&&(c=!0,e.selected_part=0,e.canvas.loadFromJSON(r,function(){e.canvas.renderAll.bind(e.canvas),S()}),e.canvas.calcOffset(),v(),r.indexOf('{"type":"text"')>-1&&b())}})}),c?h(0):t("#wpc-parts-bar > li").first().click()}setTimeout(function(){e.canvas.renderAll()},500)}function v(){var e=t("#wpc-parts-bar > li").first().attr("data-url"),a="url('"+e+"') no-repeat center center";t("#wpc-editor-container").css("background",a)}function g(){"undefined"==typeof to_load&&t("#wpc-parts-bar > li").each(function(a){var n=t(this).attr("data-id");e.serialized_parts[n]=[],e.canvasManipulationsPosition[n]=-1;var c=t("#wpc-parts-bar > li").length;a==c-1&&_(wpd.output_loop_delay,f,function(){t("#wpc-parts-bar > li").first().click(),e.canvas.renderAll(),S(),t.unblockUI()})})}function f(e){t("#wpc-parts-bar > li:eq("+e+")").click()}function _(e,a,n){t.blockUI({message:wpd.translated_strings.loading_msg});var c=t("#wpc-parts-bar > li").length,o=0,r=setInterval(function(){t.isFunction(a)&&a(o),o==c-1?(window.clearInterval(r),t.isFunction(n)?setTimeout(function(){n()},e):t.unblockUI()):o++},e)}function h(a,n,c){var o=t("#wpc-parts-bar > li:eq("+a+")"),r=o.attr("data-ovni");"undefined"==typeof c&&(c=!1);var i=o.data("bg");""==i&&(i=null);var l=o.data("ov");""==l&&(l=null);var s=new Image;if(s.onload=function(){var t=e.get_img_best_fit_dimensions(s,wpd.canvas_w,wpd.canvas_h);e.canvas.setBackgroundImage(s.src,e.canvas.renderAll.bind(e.canvas),{left:wpd.canvas_w/2,top:wpd.canvas_h/2,originX:"center",originY:"center",width:t[0],height:t[1]})},null!=i?s.src=i:e.canvas.backgroundImage=null,"jpg"==wpd.output_format&&e.canvas.setBackgroundColor("rgba(255, 255, 255, 1)",e.canvas.renderAll.bind(e.canvas)),"-1"==r&&c)e.canvas.overlayImage=null,e.canvas.renderAll.bind(e.canvas);else{var d=new Image;d.onload=function(){var t=e.get_img_best_fit_dimensions(d,wpd.canvas_w,wpd.canvas_h);e.canvas.setOverlayImage(d.src,e.canvas.renderAll.bind(e.canvas),{left:wpd.canvas_w/2,top:wpd.canvas_h/2,originX:"center",originY:"center",width:t[0],height:t[1]})},null!=l?d.src=l:e.canvas.overlayImage=null}t.isFunction(n)&&setTimeout(function(){n(a)},200)}function w(a){var n=t("#"+a),c=n.data("index"),o=n.css("background-color");o||(o="#0000ff"),"custom"==wpd.palette_type?n.qtip({content:"<div class='wpc-custom-svg-colors-container' data-id='"+a+"' data-index='"+c+"'>"+wpd.palette_tpl+"</div>",position:{corner:{target:"middleRight",tooltip:"leftTop"}},style:{width:200,padding:5,background:"white",color:"black",border:{width:1,radius:1,color:"#08AED6"}},tip:"bottomLeft",show:"click",hide:{when:{event:"unfocus"}}}):n.ColorPicker({color:o,onShow:function(e){return t(e).fadeIn(500),!1},onHide:function(a){t(a).fadeOut(500);var n=e.canvas.getActiveObject();return null!=n&&e.save_canvas(),!1},onChange:function(t,e,n){m(a,e,c)}})}function m(a,n,c){t("#"+a).css("background-color","#"+n);var o=e.canvas.getActiveObject();if(null!=o&&("path"==o.type||"path-group"==o.type)){if(o.isSameColor&&o.isSameColor()||!o.paths)o.set("fill","#"+n);else if(o.paths)if("by-colors"==wpd.svg_colorization){c=t("#"+a).attr("data-index");var r=c.split(",");t.each(r,function(t,e){o.paths[e].setFill("#"+n)})}else o.paths[c].setFill("#"+n);e.canvas.renderAll()}}function b(){var a=["active","angle","backgroundColor","clipTo","currentHeight","currentWidth","fill","currentWidth","flipX","flipY","fontFamily","fontSize","fontStyle","fontWeight","height","left","lineHeight","originX","originY","scaleX","scaleY","shadow","text","textAlign","textBackgroundColor","textDecoration","top","width","lockMovementX","lockMovementY","lockRotation","lockScalingX","lockScalingY","lockUniScaling"];setTimeout(function(){var n=e.canvas.getObjects().map(function(t){return t});t.each(n,function(n,c){if("text"==c.type){var o=new fabric.IText("");t.each(a,function(t,e){o.set(e,c.get(e))}),e.canvas.remove(c),e.canvas.add(o)}}),e.canvas.renderAll.bind(e.canvas)},3600)}function k(){t("#new-text").val(""),t(".txt-align").removeAttr("checked"),t(".txt-decoration").removeAttr("checked"),t("#bold-cb").removeAttr("checked"),t("#italic-cb").removeAttr("checked"),t("#font-family-selector").val(t("#font-family-selector option:first").val()).trigger("change"),t("#o-thickness-slider").val(t("#o-thickness-slider option:first").val()),t("#opacity-slider").val(1)}function y(t){x(t,!1)}function x(a,c){e.selected_part=a,c="undefined"!=typeof c?c:!0;var o=t("#wpc-parts-bar > li:eq("+a+")").attr("data-id"),r=t("#wpc-parts-bar > li:eq("+a+")").attr("data-url");e.canvas.clear(),"undefined"==typeof e.serialized_parts[o]&&(e.serialized_parts[o]=["{}"]),e.canvas.loadFromJSON(e.serialized_parts[o][e.canvasManipulationsPosition[o]],function(){n(),h(e.selected_part,function(){var a=wpd.output_w/e.canvas.getWidth();c&&(a=1),a/=2;var i=e.canvas.toDataURL({format:wpd.output_format,multiplier:a,quality:1}),l="";wpd.generate_svg&&(l=e.canvas.toSVG());var s=j(i);if(c){var d="";if(wpd.watermark){var p=new FormData;p.append("action","get_watermarked_preview"),p.append("watermark",wpd.watermark),p.append("product-id",wpd.global_variation_id),p.append("image",s),t.ajax({type:"POST",url:ajax_object.ajax_url,data:p,processData:!1,contentType:!1}).done(function(a){if(e.is_json(a)){var n=JSON.parse(a);d=r?"<div style='background-image:url("+r+");'><img src='"+n.url+"'></div>":"<div><img src='"+n.url+"'></div>",t("#wpd-modal .omodal-body").append(d)}else t("#debug").html(a)})}else d=r?"<div style='background-image:url("+r+");'><img src='"+i+"'></div>":"<div><img src='"+i+"'></div>",t("#wpd-modal .omodal-body").append(d)}else{var u=t.parseJSON(e.serialized_parts[o][e.canvasManipulationsPosition[o]]),v=[];if(wpd.print_layers){var g=u.objects;t.each(g,function(t,a){e.canvas.clear();var c=u;c.objects=[a];var r=JSON.stringify(c);e.canvas.loadFromJSON(r,function(){n(),e.canvas.renderAll.bind(e.canvas),h(e.selected_part,"",!0);var a=wpd.output_w/e.canvas.getWidth();a/=2;var c=e.canvas.toDataURL({format:wpd.output_format,multiplier:a,quality:1}),r=j(c);v.push(r),t==g.length-1&&(e.canvas.loadFromJSON(e.serialized_parts[o][e.canvasManipulationsPosition[o]]),n())})})}e.final_canvas_parts[o]={json:e.serialized_parts[o][e.canvasManipulationsPosition[o]],image:s,original_part_img:r,layers:v,svg:l}}h(e.selected_part)},!0)})}function j(t){var e;e=t.split(",")[0].indexOf("base64")>=0?atob(t.split(",")[1]):unescape(t.split(",")[1]);for(var a=t.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(e.length),c=0;c<e.length;c++)n[c]=e.charCodeAt(c);var o=new Blob([n],{type:a});return o}function A(a){return t.each(e.final_canvas_parts,function(e,n){t.each(n,function(n,c){"image"==n?a.append(e+"["+n+"]",c):"layers"==n?t.each(c,function(t,n){a.append("layers["+e+"][]",n)}):a.append("final_canvas_parts["+e+"]["+n+"]",c)})}),a}function O(){var a=t("#wpc-parts-bar > li:eq(0)").attr("data-id");e.canvas.clear(),e.canvas.loadFromJSON(e.serialized_parts[a][e.canvasManipulationsPosition[a]],function(){e.canvas.renderAll.bind(e.canvas),S()})}function S(){if(1!=wpd.responsive)return!1;var t=a(),c=t[0]/wpd.canvas_w;1!=c&&(e.scale_factor=c,e.canvas.setWidth(t[0]),e.canvas.setHeight(t[1]),e.canvas.setZoom(c),e.canvas.calcOffset(),e.canvas.renderAll()),n()}function T(){t(".canvas-container").hide(),S(),r(),t(".canvas-container").show()}function D(t,e,a,n,c,o,r,i){"undefined"==typeof i&&(i=!1),"undefined"==typeof o&&(o=5),t.beginPath(),t.moveTo(e+o,a),t.lineTo(e+n-o,a),t.quadraticCurveTo(e+n,a,e+n,a+o),t.lineTo(e+n,a+c-o),t.quadraticCurveTo(e+n,a+c,e+n-o,a+c),t.lineTo(e+o,a+c),t.quadraticCurveTo(e,a+c,e,a+c-o),t.lineTo(e,a+o),t.quadraticCurveTo(e,a,e+o,a),t.closePath(),i&&(t.strokeStyle=i,t.stroke()),r&&t.fill()}t(".wpd-responsive-mode .wpc-editor-menu").toggle(function(){t(".wpd-responsive-mode .wpc-editor-col:first-child").css("display","inline-block")},function(){t(".wpd-responsive-mode .wpc-editor-col:first-child").css("display","none")}),t(".wpd-responsive-mode .wpc-editor-menu-right").toggle(function(){t(".wpd-responsive-mode .wpc-editor-col.right").css("display","inline-block")},function(){t(".wpd-responsive-mode .wpc-editor-col.right").css("display","none")});var F,P=new Spry.Widget.Accordion("wpc-tools-box-container",{useFixedPanelHeights:!1,defaultPanel:-1});new Spry.Widget.Accordion("my-designs-accordion",{useFixedPanelHeights:!1,defaultPanel:-1}),t("[data-tooltip-title]").otooltip(),o(),g(),t(document).on("click","#wpc-parts-bar > li",function(a){var n=t(this).attr("data-url");if(e.selected_part!=t(this).index()){if(h(t(this).index()),t("#wpc-parts-bar > li").removeClass("active"),t(this).addClass("active"),e.selected_part>=0&&(e.save_canvas(),e.canvas.clear()),e.selected_part=t(this).index(),n){var c="url('"+n+"') no-repeat center center";t("#wpc-editor-container").css("background",c)}else t("#wpc-editor-container").css("background","none");var o=t(this).attr("data-id");"undefined"==typeof e.serialized_parts[o]&&(e.serialized_parts[o]=[],e.canvasManipulationsPosition[o]=-1),e.serialized_parts[o][e.canvasManipulationsPosition[o]]&&(t.blockUI({message:wpd.translated_strings.loading_msg}),e.canvas.loadFromJSON(e.serialized_parts[o][e.canvasManipulationsPosition[o]],function(){S(),t.unblockUI()})),e.refresh_undo_redo_status()}}),"undefined"!=typeof to_load&&setTimeout(function(){u(to_load)},500),e.setCustomProperties=function(t){l(t)},e.is_json=function(t){return/^[\],:{}\s]*$/.test(t.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))?!0:!1},e.save_canvas=function(){var a=t("#wpc-parts-bar > li:eq("+e.selected_part+")").attr("data-id");"undefined"==typeof e.serialized_parts[a]&&(e.serialized_parts[a]=["{}"]);var n;for(n=e.canvasManipulationsPosition[a];n<=e.serialized_parts[a].length-2;n++)e.serialized_parts[a].pop();e.canvasManipulationsPosition[a]++;var c=JSON.stringify(e.canvas.toJSON(["lockMovementX","lockMovementY","lockRotation","lockScalingX","lockScalingY","price","lockDeletion","originalText","radius","spacing"]));e.serialized_parts[a].push(c),p(),e.refresh_undo_redo_status()},e.reload_background_overlay_if_needed=function(t,e){h(t,e)},e.centerObjectH=function(t){var a=t.getWidth();e.scale_factor&&(a*=e.scale_factor);var n=(parseFloat(wpd.canvas_w)-a)/2;e.box_center_x&&(n=e.box_center_x-a/2),e.scale_factor&&(n/=e.scale_factor),t.set("left",n)},e.centerObjectV=function(t){var a=t.getHeight();e.scale_factor&&(a*=e.scale_factor);var n=(parseFloat(wpd.canvas_h)-a)/2;e.box_center_y&&(n=parseFloat(e.box_center_y)-a/2),e.scale_factor&&(n/=e.scale_factor),t.set("top",n)},e.centerObject=function(t){e.centerObjectV(t),e.centerObjectH(t)},e.change_item_color=function(a,n){t("#"+a).css("background-color","#"+n);var c=e.canvas.getActiveObject();null!=c&&"group"!=c.type?d(a,c,n):null!=c&&"group"==c.type&&c.forEachObject(function(t){d(a,t,n)})},e.refresh_undo_redo_status=function(){var a=t("#wpc-parts-bar > li:eq("+e.selected_part+")").attr("data-id");1==e.serialized_parts[a].length||0==e.canvasManipulationsPosition[a]?t("#undo-btn").addClass("disabled"):t("#undo-btn").removeClass("disabled"),e.serialized_parts[a].length>0&&e.canvasManipulationsPosition[a]<e.serialized_parts[a].length-1?t("#redo-btn").removeClass("disabled"):t("#redo-btn").addClass("disabled")},e.get_img_best_fit_dimensions=function(t,e,a){var n=t.width,c=t.height;if(e>n&&a>c)return[n,c];var o=n/c;return n=e,c=e/o,c>a&&(c=a,n=a*o),wp.hooks.applyFilters("WPD_EDITOR.wpd_img_dimensions",[n,c],t)},t(document).on("click",".wpc-custom-colors-container span",function(a){var n=t(this).parent().data("id"),c=t(this).data("color");e.change_item_color(n,c)}),t(document).on("click",".wpc-custom-svg-colors-container span",function(e){var a=t(this).parent().data("id"),n=t(this).parent().data("index"),c=t(this).data("color");m(a,c,n)}),t(document).on("touchstart click","#preview-btn",function(a){a.preventDefault(),t("#wpd-modal .omodal-body").html(""),e.save_canvas(),"no"==wpd.clip_include_in_output&&(e.canvas.clipTo=null),_(wpd.output_loop_delay,x,function(){t("#wpc-parts-bar > li").first().click(),t("#wpd-modal").omodal("show"),r(),t.unblockUI()})}),t(document).on("click","#download-btn",function(){t("#debug").html(""),"no"==wpd.clip_include_in_output&&(e.canvas.clipTo=null),_(wpd.output_loop_delay,y,function(){if(jQuery.isEmptyObject(e.final_canvas_parts))t("#debug").html("<div class='wpc-failure'>"+wpd.translated_strings.empty_object_msg+"</div>"),r(),t.unblockUI();else{var a=wpd.global_variation_id,n=new FormData;n.append("action","generate_downloadable_file"),n.append("variation_id",a),n.append("format",wpd.output_format),n=A(n),t.ajax({type:"POST",url:ajax_object.ajax_url,data:n,processData:!1,contentType:!1}).done(function(a){if(r(),t.unblockUI(),e.is_json(a)){var n=JSON.parse(a);t("#wpc-parts-bar > li").length>1?t("#wpc-parts-bar > li").first().click():O(),t("#debug").html(n.message),wp.hooks.doAction("WPD_EDITOR.download_files_complete")}else t("#debug").html(a)})}})}),t(document).on("touchstart click","#save-btn",function(){_(wpd.output_loop_delay,y,function(){if(jQuery.isEmptyObject(e.final_canvas_parts))t("#debug").html("<div class='wpc-failure'>"+wpd.translated_strings.empty_object_msg+"</div>"),t.unblockUI();else{var a=(t("#wpd-qty").val(),t("#save-btn").data("index")),n=wpd.global_variation_id,c=new FormData;c.append("action","save_custom_design_for_later"),c.append("variation_id",n),c.append("design_index",a),c=A(c),t.ajax({type:"POST",url:ajax_object.ajax_url,data:c,processData:!1,contentType:!1}).done(function(a){if(t.unblockUI(),e.is_json(a)){var n=JSON.parse(a);t("#wpc-parts-bar > li").first().click(),a.is_logged?a.success&&t(location).attr("href",n.url):t(location).attr("href",n.url)}else t("#debug").html(a)})}})}),t(document).on("click",".wpc-qty-container .plus, .wpc-qty-container .minus",function(){var e=t(this).siblings(".wpd-qty"),a=parseFloat(e.val()),n=parseFloat(e.attr("max")),c=parseFloat(e.attr("min")),o=e.attr("step");a&&""!==a&&"NaN"!==a||(a=0),(""===n||"NaN"===n)&&(n=""),(""===c||"NaN"===c)&&(c=0),("any"===o||""===o||void 0===o||"NaN"===parseFloat(o))&&(o=1),t(this).is(".plus")?n&&(n==a||a>n)?e.val(n):e.val(a+parseFloat(o)):c&&(c==a||c>a)?e.val(c):a>0&&e.val(a-parseFloat(o)),e.trigger("change"),p()}),t(".wpd-rp-attribute.cart-item-edit").click(function(){return confirm(wpd.translated_strings.cart_item_edition_switch)}),t(document).on("touchstart click",".wpd-rp-attribute",function(a){a.preventDefault();var n={},c=t(this).attr("href");t.each(e.serialized_parts,function(t,e){n[t]=e[e.length-1]});var o=JSON.stringify(n);t.post(ajax_object.ajax_url,{action:"save_data_to_reload",serialized_parts:o},function(a){e.is_json(a)?t(location).attr("href",c):t("#debug").html(a)})}),t(document).on("change",".wpd-qty",function(){var e=t(this).val(),a=t(this).attr("uprice"),n=t(this).attr("opt_price"),c=t(this).siblings(".total-price").find(".total_order");if(!t.isNumeric(e))return t(this).val(1),void c.html(accounting.formatMoney(a));t.isNumeric(n)&&(a=parseFloat(a)+parseFloat(n),a=wp.hooks.applyFilters("wpd.unit_price",a,t(this)));var o=a*e;c.html(accounting.formatMoney(o))});var M=function(){var e=new t.Deferred;return t(".wpc-container .ninja-forms-form").length>0?t(".wpc-container form.ninja-forms-form").each(function(){var a=t(this);a.find('input[type="submit"]').length<1&&a.append('<input type="submit" class="ninja-forms-field" style="display:none;"/>');var n=a.attr("id");t("#"+n).submit(),t(document).on("submitResponse.example",function(n,c){a.show(),c.success?e.resolve(!0):(t("#wpc-parts-bar > li").length>1?t("#wpc-parts-bar > li").first().click():O(),e.resolve(!1))})}):e.resolve(!0),e.promise()};t(document).on("touchstart click","#add-to-cart-btn",function(){t("#debug").html("");var a={};t.each(t(".wpc-qty-container"),function(e,n){var c=t(this).find(".wpd-qty").val();a[t(this).data("id")]=c}),e.save_canvas(),M().then(function(n){n?("no"==wpd.clip_include_in_output&&(e.canvas.clipTo=null),_(wpd.output_loop_delay,y,function(){if(jQuery.isEmptyObject(e.final_canvas_parts))t("#debug").html("<div class='wpc-failure'>"+wpd.translated_strings.empty_object_msg+"</div>"),r(),t.unblockUI();else{var n=t("#wpd-qty").val(),c=wpd.global_variation_id,o=wpd.query_vars.edit;"undefined"==typeof o&&(o="");var i=wpd.query_vars.tpl;"undefined"==typeof i&&(i="");var l=new FormData;l.append("variation_id",c),l.append("variations",JSON.stringify(a)),l.append("format",wpd.output_format),l.append("action","add_custom_design_to_cart"),l.append("cart_item_key",o),l.append("tpl",i),l.append("final_canvas_parts",e.final_canvas_parts),l.append("quantity",n);var s=JSON.stringify(get_design_options());l.append("wpd-design-opt",s),l=A(l),t.ajax({type:"POST",url:ajax_object.ajax_url,data:l,processData:!1,contentType:!1}).done(function(a){if(e.is_json(a)){var n=JSON.parse(a);t("#wpc-parts-bar > li").length>1?t("#wpc-parts-bar > li").first().click():O(),1==wpd.redirect_after&&n.success?t(location).attr("href",n.url):(t("#debug").html(n.message),r(),t.unblockUI())}else t("#debug").html(a),r(),t.unblockUI()})}})):t.unblockUI()})}),t("#lock-mvt-x, #lock-mvt-y, #lock-scl-x, #lock-scl-y, #lock-Deletion").change(function(a){var n=t(this).data("property"),c=e.canvas.getActiveObject(),o=e.canvas.getActiveGroup();null!=c?(t(this).is(":checked")?c[n]=!0:c[n]=!1,e.save_canvas()):null!=o&&(t(this).is(":checked")?o[n]=!0:o[n]=!1,e.save_canvas())}),t(".post-type-wpc-template #publish").click(function(a){a.preventDefault(),_(wpd.output_loop_delay,y,function(){if(jQuery.isEmptyObject(e.final_canvas_parts))alert(wpd.translated_strings.empty_object_msg),t.unblockUI();else{var a=new FormData;a.append("action","save_canvas_to_session"),a=A(a),t.ajax({type:"POST",url:ajax_object.ajax_url,data:a,processData:!1,contentType:!1}).done(function(e){t("#post").submit()})}})}),t(window).resize(function(){clearTimeout(F),F=setTimeout(T,500)}),t(document).keydown(function(a){var n=e.canvas.getActiveObject(),c=e.canvas.getActiveGroup();46==a.which?t("#delete_btn").click():37==a.which?null==c||c.get("lockMovementX")?null==n||n.get("lockMovementX")||(n.set("left",n.left-1),e.canvas.renderAll(),e.save_canvas()):(c.set("left",c.left-1),e.canvas.renderAll(),e.save_canvas()):39==a.which?null==c||c.get("lockMovementX")?null==n||n.get("lockMovementX")||(n.set("left",n.left+1),e.canvas.renderAll(),e.save_canvas()):(c.set("left",c.left+1),e.canvas.renderAll(),e.save_canvas()):38==a.which?null==c||c.get("lockMovementY")?null==n||n.get("lockMovementY")||(a.preventDefault(),n.set("top",n.top-1),e.canvas.renderAll(),e.save_canvas()):(a.preventDefault(),c.set("top",c.top-1),e.canvas.renderAll(),e.save_canvas()):40==a.which?null==c||c.get("lockMovementY")?null==n||n.get("lockMovementY")||(a.preventDefault(),n.set("top",n.top+1),e.canvas.renderAll(),e.save_canvas()):(a.preventDefault(),c.set("top",c.top+1),e.canvas.renderAll(),e.save_canvas()):67==a.keyCode&&a.ctrlKey?t("#copy_paste_btn").click():90==a.keyCode&&a.ctrlKey?t("#undo-btn").click():89==a.keyCode&&a.ctrlKey&&t("#redo-btn").click()}),t(".wpd-rp-attribute").mouseenter(function(){t("#wpd-rp-desc").html(t(this).data("desc"))}),t(".wpd-rp-attribute").mouseout(function(){var e=t(".wpd-rp-attribute.selected").data("desc");t("#wpd-rp-desc").html(e)}),t("canvas").bind("contextmenu",function(t){return!1})}),e}(jQuery,WPD_EDITOR);